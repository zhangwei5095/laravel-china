<!DOCTYPE html>
<html><head>
	<meta charset="utf-8">
	<title>队列 - Laravel 中文文档
</title>
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><script type="text/javascript" src="http://bam.nr-data.net/1/229d5871c8?a=12032708&pl=1432728429431&v=632.2b17625&to=ZFdUZUMCV0UHUURdWl0dY0NYTFBYAldIGkVbQg==&ap=35&be=134&fe=217&dc=91&f=%5B%5D&perf=%7B%22timing%22:%7B%22of%22:1432728429431,%22n%22:0,%22u%22:132,%22ue%22:132,%22dl%22:133,%22di%22:225,%22ds%22:225,%22de%22:304,%22dc%22:351,%22l%22:351,%22le%22:351,%22f%22:0,%22dn%22:0,%22dne%22:0,%22c%22:0,%22ce%22:0,%22rq%22:0,%22rp%22:112,%22rpe%22:209%7D,%22navigation%22:%7B%7D%7D&at=SBBXEwsYREs=&jsonp=NREUM.setToken"></script><script src="http://js-agent.newrelic.com/nr-632.min.js"></script><script src="http://www.google-analytics.com/ga.js"></script><script type="text/javascript">window.NREUM||(NREUM={}),__nr_require=function(e,n,t){function r(t){if(!n[t]){var o=n[t]={exports:{}};e[t][0].call(o.exports,function(n){var o=e[t][1][n];return r(o?o:n)},o,o.exports)}return n[t].exports}if("function"==typeof __nr_require)return __nr_require;for(var o=0;o<t.length;o++)r(t[o]);return r}({QJf3ax:[function(e,n){function t(e){function n(n,t,a){e&&e(n,t,a),a||(a={});for(var u=c(n),f=u.length,s=i(a,o,r),p=0;f>p;p++)u[p].apply(s,t);return s}function a(e,n){f[e]=c(e).concat(n)}function c(e){return f[e]||[]}function u(){return t(n)}var f={};return{on:a,emit:n,create:u,listeners:c,_events:f}}function r(){return{}}var o="nr@context",i=e("gos");n.exports=t()},{gos:"7eSDFh"}],ee:[function(e,n){n.exports=e("QJf3ax")},{}],3:[function(e,n){function t(e){return function(){r(e,[(new Date).getTime()].concat(i(arguments)))}}var r=e("handle"),o=e(1),i=e(2);"undefined"==typeof window.newrelic&&(newrelic=window.NREUM);var a=["setPageViewName","addPageAction","setCustomAttribute","finished","addToTrace","inlineHit","noticeError"];o(a,function(e,n){window.NREUM[n]=t("api-"+n)}),n.exports=window.NREUM},{1:12,2:13,handle:"D5DuLP"}],"7eSDFh":[function(e,n){function t(e,n,t){if(r.call(e,n))return e[n];var o=t();if(Object.defineProperty&&Object.keys)try{return Object.defineProperty(e,n,{value:o,writable:!0,enumerable:!1}),o}catch(i){}return e[n]=o,o}var r=Object.prototype.hasOwnProperty;n.exports=t},{}],gos:[function(e,n){n.exports=e("7eSDFh")},{}],handle:[function(e,n){n.exports=e("D5DuLP")},{}],D5DuLP:[function(e,n){function t(e,n,t){return r.listeners(e).length?r.emit(e,n,t):(o[e]||(o[e]=[]),void o[e].push(n))}var r=e("ee").create(),o={};n.exports=t,t.ee=r,r.q=o},{ee:"QJf3ax"}],id:[function(e,n){n.exports=e("XL7HBI")},{}],XL7HBI:[function(e,n){function t(e){var n=typeof e;return!e||"object"!==n&&"function"!==n?-1:e===window?0:i(e,o,function(){return r++})}var r=1,o="nr@id",i=e("gos");n.exports=t},{gos:"7eSDFh"}],G9z0Bl:[function(e,n){function t(){var e=d.info=NREUM.info,n=f.getElementsByTagName("script")[0];if(e&&e.licenseKey&&e.applicationID&&n){c(p,function(n,t){n in e||(e[n]=t)});var t="https"===s.split(":")[0]||e.sslForHttp;d.proto=t?"https://":"http://",a("mark",["onload",i()]);var r=f.createElement("script");r.src=d.proto+e.agent,n.parentNode.insertBefore(r,n)}}function r(){"complete"===f.readyState&&o()}function o(){a("mark",["domContent",i()])}function i(){return(new Date).getTime()}var a=e("handle"),c=e(1),u=(e(2),window),f=u.document,s=(""+location).split("?")[0],p={beacon:"bam.nr-data.net",errorBeacon:"bam.nr-data.net",agent:"js-agent.newrelic.com/nr-632.min.js"},d=n.exports={offset:i(),origin:s,features:{}};f.addEventListener?(f.addEventListener("DOMContentLoaded",o,!1),u.addEventListener("load",t,!1)):(f.attachEvent("onreadystatechange",r),u.attachEvent("onload",t)),a("mark",["firstbyte",i()])},{1:12,2:3,handle:"D5DuLP"}],loader:[function(e,n){n.exports=e("G9z0Bl")},{}],12:[function(e,n){function t(e,n){var t=[],o="",i=0;for(o in e)r.call(e,o)&&(t[i]=n(o,e[o]),i+=1);return t}var r=Object.prototype.hasOwnProperty;n.exports=t},{}],13:[function(e,n){function t(e,n,t){n||(n=0),"undefined"==typeof t&&(t=e?e.length:0);for(var r=-1,o=t-n||0,i=Array(0>o?0:o);++r<o;)i[r]=e[n+r];return i}n.exports=t},{}]},{},["G9z0Bl"]);</script>
	<meta name="author" content="Laravel 中国">
	<meta name="description" content="队列,设定,基本用法,队列闭包,运行队列监听,常驻队列工作,推送队列,失败的工作,设定,Laravel 队列组件提供了一个统一的队列服务API，队列允许您将一个任务延后执行，例如可以将邮件延后至您指定的时间再发送，进而大幅的加快您开发网站应用程序的效率。,队列的配置文件在 app/config/queue.php，在这个文件里您将可以找到框架中每种不同的队列服务的连接配置，其中包含了 Beanst...
">
	<meta name="keywords" content="laravel,laravel中国,laravel中文,laravel框架中文,laravel文档,laravel框架中国,laravel中文文档">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!--[if lte IE 9]>
		<script src="http://libs.useso.com/js/html5shiv/3.7/html5shiv.min.js"></script>
	<![endif]-->
	<link rel="stylesheet" href="../../assets/css/laravel.css">
</head>
<body class="docs language-php scotchified" style=""><div class="scotch-panel-wrapper" style="position: relative; overflow: hidden; width: 100%;"><div class="scotch-panel-canvas" style="position: relative; height: 100%; width: 100%; -webkit-transform: translate3d(0, 0, 0); -webkit-backface-visibility: hidden; -webkit-transition: all 300ms ease; transition: all 300ms ease;">

	<span class="overlay"></span>

	<nav class="main">
		<div class="container">
			<a href="../../index.html" class="brand">
				<img src="../../assets/img/laravel-logo.png" height="30">
				Laravel
			</a>

			<div class="responsive-sidebar-nav">
				<a href="queues.html#" class="toggle-slide menu-link btn">☰</a>
			</div>

							<div class="switcher">
	<div class="dropdown">
		<button class="btn dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-expanded="true">
			<!--<span class="faint">v</span> -->
			4.2
			<span class="caret"></span>
		</button>
		<ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1">
							<li role="presentation">
					<a role="menuitem" tabindex="-1" href="../5.0/queues.html">5.0</a>
				</li>
							<li role="presentation">
					<a role="menuitem" tabindex="-1" href="queues.html">4.2</a>
				</li>
					</ul>
	</div>
</div>
			
			<ul class="main-nav">
				<li class="nav-docs"><a href="../5.0.html">文档</a></li>
<li class="nav-laracasts"><a href="https://laracasts.com" target="_blank">Laracasts</a></li>
<li class="nav-docs"><a href="http://lumen.laravel-china.org">Lumen</a></li>
<li class="nav-forge"><a href="https://forge.laravel.com" target="_blank">Forge</a></li>
<li class="nav-api" style="display:none"><a href="http://laravel-china.org/api/5.0" target="_blank">API</a></li>
<li class="dropdown">
	<a href="https://phphub.org/" target="_blank">中文开发者社区</a>
</li>
<li class="dropdown">
	<a href="https://phphub.org/topics/453" target="_blank">Slack 聊天室</a>
</li>
<a href="https://github.com/laravel-china/docs" target="_blank"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/a6677b08c955af8400f44c6298f40e7d19cc5b2d/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"></a>
			</ul>
		</div>
	</nav>

	<nav id="slide-menu" class="slide-menu scotch-panel-left" role="navigation" style="top: 0px; left: -70%; width: 70%; height: 100%; position: absolute; z-index: 888888; overflow: hidden; -webkit-backface-visibility: hidden;">

	<div class="brand">
		<a href="../../index.html">
			<img src="../../assets/img/laravel-logo-white.png" height="50">
		</a>
	</div>

	<ul class="slide-main-nav">
		<li><a href="../../index.html">Home</a></li>
		<li class="nav-docs"><a href="../5.0.html">文档</a></li>
<li class="nav-laracasts"><a href="https://laracasts.com" target="_blank">Laracasts</a></li>
<li class="nav-docs"><a href="http://lumen.laravel-china.org">Lumen</a></li>
<li class="nav-forge"><a href="https://forge.laravel.com" target="_blank">Forge</a></li>
<li class="nav-api" style="display:none"><a href="http://laravel-china.org/api/5.0" target="_blank">API</a></li>
<li class="dropdown">
	<a href="https://phphub.org/" target="_blank">中文开发者社区</a>
</li>
<li class="dropdown">
	<a href="https://phphub.org/topics/453" target="_blank">Slack 聊天室</a>
</li>
<a href="https://github.com/laravel-china/docs" target="_blank"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/a6677b08c955af8400f44c6298f40e7d19cc5b2d/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"></a>
	</ul>

	<div class="slide-docs-nav">
		<h2>文档</h2>
		<span>文档更新于: 2015-04-11</span>
		<ul>
<li>前言
<ul>
<li><a href="introduction.html">Laravel 介绍</a></li>
<li><a href="quick.html">快速入门</a></li>
<li><a href="releases.html">框架更新记录</a></li>
<li><a href="upgrade.html">升级指南</a></li>
</ul></li>
<li>快速上手
<ul>
<li><a href="installation.html">安装文档</a></li>
<li><a href="configuration.html">配置信息</a></li>
<li><a href="homestead.html">Homestead</a></li>
<li><a href="lifecycle.html">程序的生命周期</a></li>
<li><a href="routing.html">路由 Routing</a></li>
<li><a href="requests.html">处理用户请求和输入</a></li>
<li><a href="responses.html">视图和响应</a></li>
<li><a href="controllers.html">控制器</a></li>
<li><a href="errors.html">错误和日志</a></li>
</ul></li>
<li>更多 Laravel 知识
<ul>
<li><a href="security.html">身份认证功能</a></li>
<li><a href="billing.html">收费系统</a></li>
<li><a href="cache.html">缓存</a></li>
<li><a href="extending.html">扩展框架</a></li>
<li><a href="events.html">事件</a></li>
<li><a href="facades.html">Facades</a></li>
<li><a href="html.html">表单和HTML</a></li>
<li><a href="helpers.html">帮助函数</a></li>
<li><a href="ioc.html">IoC Container</a></li>
<li><a href="localization.html">本地化</a></li>
<li><a href="mail.html">邮件发送 Mail</a></li>
<li><a href="packages.html">扩展包开发</a></li>
<li><a href="pagination.html">分页功能</a></li>
<li><a href="queues.html">队列</a></li>
<li><a href="security.html">安全</a></li>
<li><a href="session.html">会话</a></li>
<li><a href="ssh.html">远程连接模块 SSH</a></li>
<li><a href="templates.html">模版引擎</a></li>
<li><a href="testing.html">单元测试</a></li>
<li><a href="validation.html">表单验证</a></li>
</ul></li>
<li>数据库 Database
<ul>
<li><a href="database.html">数据库简单使用</a></li>
<li><a href="queries.html">查询构造器</a></li>
<li><a href="eloquent.html">Eloquent ORM</a></li>
<li><a href="schema.html">表结构构造器</a></li>
<li><a href="migrations.html">Migrations &amp; Seeding</a></li>
<li><a href="redis.html">Redis</a></li>
</ul></li>
<li>命令行 Artisan CLI
<ul>
<li><a href="artisan.html">命令行 Artisan 介绍</a></li>
<li><a href="commands.html">开发 Artisan 命令</a></li>
</ul></li>
</ul>
	</div>

</nav>

<div class="docs-wrapper container">

	<section class="sidebar">
		<span>文档更新于: 2015-04-11</span>
		<ul>
<li>前言
<ul>
<li><a href="introduction.html">Laravel 介绍</a></li>
<li><a href="quick.html">快速入门</a></li>
<li><a href="releases.html">框架更新记录</a></li>
<li><a href="upgrade.html">升级指南</a></li>
</ul></li>
<li>快速上手
<ul>
<li><a href="installation.html">安装文档</a></li>
<li><a href="configuration.html">配置信息</a></li>
<li><a href="homestead.html">Homestead</a></li>
<li><a href="lifecycle.html">程序的生命周期</a></li>
<li><a href="routing.html">路由 Routing</a></li>
<li><a href="requests.html">处理用户请求和输入</a></li>
<li><a href="responses.html">视图和响应</a></li>
<li><a href="controllers.html">控制器</a></li>
<li><a href="errors.html">错误和日志</a></li>
</ul></li>
<li>更多 Laravel 知识
<ul>
<li><a href="security.html">身份认证功能</a></li>
<li><a href="billing.html">收费系统</a></li>
<li><a href="cache.html">缓存</a></li>
<li><a href="extending.html">扩展框架</a></li>
<li><a href="events.html">事件</a></li>
<li><a href="facades.html">Facades</a></li>
<li><a href="html.html">表单和HTML</a></li>
<li><a href="helpers.html">帮助函数</a></li>
<li><a href="ioc.html">IoC Container</a></li>
<li><a href="localization.html">本地化</a></li>
<li><a href="mail.html">邮件发送 Mail</a></li>
<li><a href="packages.html">扩展包开发</a></li>
<li><a href="pagination.html">分页功能</a></li>
<li><a href="queues.html">队列</a></li>
<li><a href="security.html">安全</a></li>
<li><a href="session.html">会话</a></li>
<li><a href="ssh.html">远程连接模块 SSH</a></li>
<li><a href="templates.html">模版引擎</a></li>
<li><a href="testing.html">单元测试</a></li>
<li><a href="validation.html">表单验证</a></li>
</ul></li>
<li>数据库 Database
<ul>
<li><a href="database.html">数据库简单使用</a></li>
<li><a href="queries.html">查询构造器</a></li>
<li><a href="eloquent.html">Eloquent ORM</a></li>
<li><a href="schema.html">表结构构造器</a></li>
<li><a href="migrations.html">Migrations &amp; Seeding</a></li>
<li><a href="redis.html">Redis</a></li>
</ul></li>
<li>命令行 Artisan CLI
<ul>
<li><a href="artisan.html">命令行 Artisan 介绍</a></li>
<li><a href="commands.html">开发 Artisan 命令</a></li>
</ul></li>
</ul>
	</section>

	<article>
		<h1>队列</h1>
<ul>
<li><a href="queues.html#configuration">设定</a></li>
<li><a href="queues.html#basic-usage">基本用法</a></li>
<li><a href="queues.html#queueing-closures">队列闭包</a></li>
<li><a href="queues.html#running-the-queue-listener">运行队列监听</a></li>
<li><a href="queues.html#daemon-queue-worker">常驻队列工作</a></li>
<li><a href="queues.html#push-queues">推送队列</a></li>
<li><a href="queues.html#failed-jobs">失败的工作</a></li>
</ul>
<p><a name="configuration"></a></p>
<h2><a href="queues.html#configuration">设定</a></h2>
<p>Laravel 队列组件提供了一个统一的队列服务API，队列允许您将一个任务延后执行，例如可以将邮件延后至您指定的时间再发送，进而大幅的加快您开发网站应用程序的效率。</p>
<p>队列的配置文件在 <code class=" language-php">app<span class="token operator">/</span>config<span class="token operator">/</span>queue<span class="token punctuation">.</span>php</code>，在这个文件里您将可以找到框架中每种不同的队列服务的连接配置，其中包含了 <a href="http://kr.github.com/beanstalkd">Beanstalkd</a>，<a href="http://iron.io">IronMQ</a>，<a href="http://aws.amazon.com/sqs">Amazon SQS</a>，<a href="http://redis.io">Redis</a>，以及同步(本地端使用)驱动设定。</p>
<p>下列的 composer.json 表示您的队列服务所需要的依赖环境：</p>
<ul>
<li>Beanstalkd: <code class=" language-php">pda<span class="token operator">/</span>pheanstalk <span class="token operator">~</span><span class="token number">3.0</span></code></li>
<li>Amazon SQS: <code class=" language-php">aws<span class="token operator">/</span>aws<span class="token operator">-</span>sdk<span class="token operator">-</span>php</code></li>
<li>IronMQ: <code class=" language-php">iron<span class="token operator">-</span>io<span class="token operator">/</span>iron_mq</code></li>
</ul>
<p><a name="basic-usage"></a></p>
<h2><a href="queues.html#basic-usage">基本用法</a></h2>
<h4>推送一个工作至队列</h4>
<p>要推送一个新的工作至队列，请使用 <code class=" language-php"><span class="token scope">Queue<span class="token punctuation">::</span></span>push</code> 方法：</p>
<pre class=" language-php"><code class=" language-php"><span class="token scope">Queue<span class="token punctuation">::</span></span><span class="token function">push<span class="token punctuation">(</span></span><span class="token string">'SendEmail'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'message'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$message</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h4>定义一个工作处理程序</h4>
<p><code class=" language-php">push</code> 方法的第一个参数为应该处理这个工作的类方法名称，第二个参数是一个要传递至处理程序的数组，一个工作处理程序应该参照下列定义：</p>
<pre class=" language-php"><code class=" language-php"><span class="token keyword">class</span> <span class="token class-name">SendEmail</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">fire<span class="token punctuation">(</span></span><span class="token variable">$job</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
       <span class="token comment" spellcheck="true"> //
</span>    <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre>
<p>注意如果您未在第一个参数指定工作处理的类及方法(如 SendEmail@process)，那 <code class=" language-php">fire</code> 为类中默认必需的方法用来接收被推送至队列 <code class=" language-php">Job</code> 实例以及 <code class=" language-php">data</code>。</p>
<h4>指定一个特定的处理程序方法</h4>
<p>假如您想要用一个 <code class=" language-php">fire</code> 以外的方法处理工作，您可以在推送工作时指定方法如下：</p>
<pre class=" language-php"><code class=" language-php"><span class="token scope">Queue<span class="token punctuation">::</span></span><span class="token function">push<span class="token punctuation">(</span></span><span class="token string">'SendEmail@send'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'message'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$message</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h4>指定队列使用特定连接</h4>
<p>您也可指定队列工作送至指定的连接：</p>
<pre class=" language-php"><code class=" language-php"><span class="token scope">Queue<span class="token punctuation">::</span></span><span class="token function">push<span class="token punctuation">(</span></span><span class="token string">'SendEmail@send'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'message'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$message</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'emails'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h4>发送相同的数据去多个连接</h4>
<p>如果您需要传送一样的数据去几个不同的队列服务器，您也可以使用 <code class=" language-php"><span class="token scope">Queue<span class="token punctuation">::</span></span>bulk</code> 方法：</p>
<pre class=" language-php"><code class=" language-php"><span class="token scope">Queue<span class="token punctuation">::</span></span><span class="token function">bulk<span class="token punctuation">(</span></span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'SendEmail'</span><span class="token punctuation">,</span> <span class="token string">'NotifyUser'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$payload</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h4>延迟执行一个工作</h4>
<p>有时后您也希望延迟一个队列工作的执行，举例来说您希望一个队列工作在客户注册 15 分钟后发送一个 e-mail，您可以使用 <code class=" language-php"><span class="token scope">Queue<span class="token punctuation">::</span></span>later</code> 方法来完成这件事情：</p>
<pre class=" language-php"><code class=" language-php"><span class="token variable">$date</span> <span class="token operator">=</span> <span class="token scope">Carbon<span class="token punctuation">::</span></span><span class="token function">now<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">addMinutes<span class="token punctuation">(</span></span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token scope">Queue<span class="token punctuation">::</span></span><span class="token function">later<span class="token punctuation">(</span></span><span class="token variable">$date</span><span class="token punctuation">,</span> <span class="token string">'SendEmail@send'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'message'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$message</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>在这个例子中，我们使用 <a href="https://github.com/briannesbitt/Carbon">Carbon</a> 日期函数库来指定我们希望队列工作希望延迟的时间，另外您也可传送一个整数来设定您希望延迟的秒数。</p>
<blockquote>
<p><strong>注意：</strong> The Amazon SQS 服务有 900s 的延迟限制 (15 分钟)。</p>
</blockquote>
<h4>删除一个处理中的工作</h4>
<p>当您已经开始处理完成一个队列工作，它就必需在队列中删除，我们可以通过 <code class=" language-php">Job</code> 实例中的 <code class=" language-php">delete</code> 方法来完成这件事：</p>
<pre class=" language-php"><code class=" language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">fire<span class="token punctuation">(</span></span><span class="token variable">$job</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
   <span class="token comment" spellcheck="true"> // Process the job...
</span>
    <span class="token variable">$job</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">delete<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h4>释放一个工作回到队列中</h4>
<p>假如您希望将一个工作释放回队列之中，您可以通过 <code class=" language-php">release</code> 方法来完成这件事情：</p>
<pre class=" language-php"><code class=" language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">fire<span class="token punctuation">(</span></span><span class="token variable">$job</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
   <span class="token comment" spellcheck="true"> // Process the job...
</span>
    <span class="token variable">$job</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">release<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>您也可以指定秒数来让这个工作延迟释放：</p>
<pre class=" language-php"><code class=" language-php"><span class="token variable">$job</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">release<span class="token punctuation">(</span></span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h4>检查工作执行次数</h4>
<p>当一个工作执行后发生错误，这个工作将会自动的释放回队列当中，您可以通过 <code class=" language-php">attempts</code> 方法来检查这个工作已经被执行的次数：</p>
<pre class=" language-php"><code class=" language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$job</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">attempts<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
   <span class="token comment" spellcheck="true"> //
</span><span class="token punctuation">}</span></code></pre>
<h4>取得一个工作的 ID</h4>
<p>您也可以取得这个工作的识别码：</p>
<pre class=" language-php"><code class=" language-php"><span class="token variable">$job</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getJobId<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><a name="queueing-closures"></a></p>
<h2><a href="queues.html#queueing-closures">队列闭包</a></h2>
<p>您也可以推送一个闭包去队列，这个方法非常的方便及快速的来处理需要使用队列的简单的任务：</p>
<pre class=" language-php"><code class=" language-php"><span class="token scope">Queue<span class="token punctuation">::</span></span><span class="token function">push<span class="token punctuation">(</span></span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$job</span><span class="token punctuation">)</span> <span class="token keyword">use</span> <span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token scope">Account<span class="token punctuation">::</span></span><span class="token function">delete<span class="token punctuation">(</span></span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$job</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">delete<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<blockquote>
<p><strong>注记:</strong> 要让一个组件变量可以在队列闭包中可以使用我们会通过 <code class=" language-php"><span class="token keyword">use</span></code> 命令，试着传送主键及重复使用的相关模组在您的队列工作中，这可以避免其他的序列化行为。</p>
</blockquote>
<p>当使用 Iron.io <a href="queues.html#push-queues">push queues</a> 时,您应该在队列闭包中采取一些其他的预防措施，我们应该在执行工作收到队列数据时检查token是否真来自 Iron.io，举例来说您推送一个队列工作到 <code class=" language-php">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>yourapp<span class="token punctuation">.</span>com<span class="token operator">/</span>queue<span class="token operator">/</span>receive<span class="token operator">?</span>token<span class="token operator">=</span>SecretToken</code>，接下来在您的工作收到队列的请求时，您就可以检查token的值是否正确。</p>
<p><a name="running-the-queue-listener"></a></p>
<h2><a href="queues.html#running-the-queue-listener">执行一个队列监听</a></h2>
<p>Laravel 内含一个 Artisan 命令，它将推送到队列的工作拉来下执行，您可以使用 <code class=" language-php">queue<span class="token punctuation">:</span>listen</code> 命令，来执行这件常驻任务：</p>
<h4>开始队列监听</h4>
<pre class=" language-php"><code class=" language-php">php artisan queue<span class="token punctuation">:</span>listen</code></pre>
<p>您也可以指定特定队列连接让监听器使用：</p>
<pre class=" language-php"><code class=" language-php">php artisan queue<span class="token punctuation">:</span>listen connection</code></pre>
<p>注意当这个任务开始时，这将会一直持续执行到他被手动停止，您也可以使用一个处理监控如 <a href="http://supervisord.org/">Supervisor</a> 来确保这个队列监听不会停止执行。</p>
<p>您也可以在 <code class=" language-php">listen</code> 命令中使用逗号分隔不同的队列连接来设定队列的重要性：</p>
<pre class=" language-php"><code class=" language-php">php artisan queue<span class="token punctuation">:</span>listen <span class="token operator">--</span>queue<span class="token operator">=</span>high<span class="token punctuation">,</span>low</code></pre>
<p>在这个范列中 <code class=" language-php">high<span class="token operator">-</span>connection</code> 将总是会优先处理队列的工作，相对于 <code class=" language-php">low<span class="token operator">-</span>connection</code></p>
<h4>指定工作超时参数</h4>
<p>您也可以设定给每个工作允许执行的秒数：</p>
<pre class=" language-php"><code class=" language-php">php artisan queue<span class="token punctuation">:</span>listen <span class="token operator">--</span>timeout<span class="token operator">=</span><span class="token number">60</span></code></pre>
<h4>指定队列休息时间</h4>
<p>此外，您也可以指定让监听器在拉取新工作时要等待几秒：</p>
<pre class=" language-php"><code class=" language-php">php artisan queue<span class="token punctuation">:</span>listen <span class="token operator">--</span>sleep<span class="token operator">=</span><span class="token number">5</span></code></pre>
<p>注意队列只会在没有队列内容时停止工作，假如队列中仍有许多可执行的工作，队列监听将持续不中断的处理</p>
<h4>处理队列上的一个工作</h4>
<p>当您只想处理队列上的一个工作您可以使用 <code class=" language-php">queue<span class="token punctuation">:</span>work</code> 命令：</p>
<pre class=" language-php"><code class=" language-php">php artisan queue<span class="token punctuation">:</span>work</code></pre>
<p><a name="daemon-queue-worker"></a></p>
<h2><a href="queues.html#daemon-queue-worker">常驻队列处理器</a></h2>
<p><code class=" language-php">queue<span class="token punctuation">:</span>work</code> 也包含了一个 <code class=" language-php"><span class="token operator">--</span>daemon</code> 选项能强迫队列处理器可以持续处理工作，即使框架重新启动了也不会停止。这种方式比起 <code class=" language-php">queue<span class="token punctuation">:</span>listen</code> 来说，可以更有效的减少CPU的使用量，不过代价是要增加了您布署时的复杂性。</p>
<p>当开始一个队列处理器处于常驻模式，使用 <code class=" language-php"><span class="token operator">--</span>daemon</code> 标示：</p>
<pre class=" language-php"><code class=" language-php">php artisan queue<span class="token punctuation">:</span>work connection <span class="token operator">--</span>daemon

php artisan queue<span class="token punctuation">:</span>work connection <span class="token operator">--</span>daemon <span class="token operator">--</span>sleep<span class="token operator">=</span><span class="token number">3</span>

php artisan queue<span class="token punctuation">:</span>work connection <span class="token operator">--</span>daemon <span class="token operator">--</span>sleep<span class="token operator">=</span><span class="token number">3</span> <span class="token operator">--</span>tries<span class="token operator">=</span><span class="token number">3</span></code></pre>
<p>如您所见 <code class=" language-php">queue<span class="token punctuation">:</span>work</code> 命令支持 <code class=" language-php">queue<span class="token punctuation">:</span>listen</code> 大多相同的选项参数，您也可使用 <code class=" language-php">php artisan help queue<span class="token punctuation">:</span>work</code> 命令来观看全部可用的选项参数。</p>
<h3>布署常驻队列处理器</h3>
<p>最简单的布署一个应用程序使用常驻队列处理器的方式就是将应用程序在开始布署时使用维护模式，您可以使用 <code class=" language-php">php artisan down</code> 命令来完成这件事情，当这个应用程序在维护模式，Laravel 将不会运行队列上的任何新工作，但会持续的处理已存在的工作。</p>
<p>最简单的重启工作的方法是在你的部署脚本中加上如下一行：</p>
<pre class=" language-php"><code class=" language-php">php artisan queue<span class="token punctuation">:</span>restart</code></pre>
<blockquote>
<p><strong>Note:</strong> This command relies on the cache system to schedule the restart. By default, APCu does not work for CLI commands. If you are using APCu, add <code class=" language-php">apc<span class="token punctuation">.</span>enable_cli<span class="token operator">=</span><span class="token number">1</span></code> to your APCu configuration.</p>
</blockquote>
<h3>Coding For Daemon Queue Workers</h3>
<p>Daemon queue workers do not restart the framework before processing each job. Therefore, you should be careful to free any heavy resources before your job finishes. For example, if you are doing image manipulation with the GD library, you should free the memory with <code class=" language-php">imagedestroy</code> when you are done.</p>
<p><a name="push-queues"></a></p>
<h2><a href="queues.html#push-queues">推送队列</a></h2>
<p>您可以利用 Laravel 4 强大的队列架构来进行推送队列工作，不需要执行任何的常驻事务或后台监听，目前只支持 <a href="http://iron.io">Iron.io</a> 驱动，在您开始前建立一个 Iron.io 帐号及新增您的 Iron 凭证到 <code class=" language-php">app<span class="token operator">/</span>config<span class="token operator">/</span>queue<span class="token punctuation">.</span>php</code> 配置文件。</p>
<h4>注册一个推送队列订阅</h4>
<p>接下来，您可以使用 <code class=" language-php">queue<span class="token punctuation">:</span>subscribe</code> 命令注册一个URL来接收新的队列推送工作：</p>
<pre class=" language-php"><code class=" language-php">php artisan queue<span class="token punctuation">:</span>subscribe queue_name http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>foo<span class="token punctuation">.</span>com<span class="token operator">/</span>queue<span class="token operator">/</span>receive</code></pre>
<p>现在当您登入您的Iron仪表板，您将会看到您新的推送队列，以及订阅的 URL，您可以订阅许多的URLs给您希望的队列，接下来建立一个 route 给您的 <code class=" language-php">queue<span class="token operator">/</span>receive</code> 及从 <code class=" language-php"><span class="token scope">Queue<span class="token punctuation">::</span></span>marshal</code> 方法回传回应：</p>
<pre class=" language-php"><code class=" language-php"><span class="token scope">Route<span class="token punctuation">::</span></span><span class="token function">post<span class="token punctuation">(</span></span><span class="token string">'queue/receive'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token scope">Queue<span class="token punctuation">::</span></span><span class="token function">marshal<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><code class=" language-php">marshal</code> 方法会将工作处理到正确的类，而发送工作到队列中只要使用一样的 <code class=" language-php"><span class="token scope">Queue<span class="token punctuation">::</span></span>push</code> 方法。</p>
<p><a name="failed-jobs"></a></p>
<h2><a href="queues.html#failed-jobs">已失败的工作</a></h2>
<p>事情往往不会如您预期的一样，有时后您推送工作到队列会失败，别担心，Laravel 包含一个简单的方法去指定一个工作最多可以被执行几次，在工作被执行到一定的次数时，他将会新增至 <code class=" language-php">failed_jobs</code> 数据库表里，然后失败工作的数据库表名称可以在 <code class=" language-php">app<span class="token operator">/</span>config<span class="token operator">/</span>queue<span class="token punctuation">.</span>php</code> 里进行设定：</p>
<p>要新增一个migration建立 <code class=" language-php">failed_jobs</code> 数据库表，您可以使用 <code class=" language-php">queue<span class="token punctuation">:</span>failed<span class="token operator">-</span>table</code> 命令：</p>
<pre class=" language-php"><code class=" language-php">php artisan queue<span class="token punctuation">:</span>failed<span class="token operator">-</span>table</code></pre>
<p>您可以指定一个最大值来限制一个工作应该最多被执行几次通过 <code class=" language-php"><span class="token operator">--</span>tries</code> 这个选项参数在您执行 <code class=" language-php">queue<span class="token punctuation">:</span>listen</code> 的时后：</p>
<pre class=" language-php"><code class=" language-php">php artisan queue<span class="token punctuation">:</span>listen connection<span class="token operator">-</span>name <span class="token operator">--</span>tries<span class="token operator">=</span><span class="token number">3</span></code></pre>
<p>假如您会想注册一个事件，这个事件会将会在队列失败时被调用，您可以使用 <code class=" language-php"><span class="token scope">Queue<span class="token punctuation">::</span></span>failing</code> 方法，这个事件是一个很好的机会让您可以通知您的团队通过 e-mail 或 <a href="https://www.hipchat.com">HipChat</a>。</p>
<pre class=" language-php"><code class=" language-php"><span class="token scope">Queue<span class="token punctuation">::</span></span><span class="token function">failing<span class="token punctuation">(</span></span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$connection</span><span class="token punctuation">,</span> <span class="token variable">$job</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
   <span class="token comment" spellcheck="true"> //
</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>要看到所有的失败工作，您可以使用 <code class=" language-php">queue<span class="token punctuation">:</span>failed</code> 命令：</p>
<pre class=" language-php"><code class=" language-php">php artisan queue<span class="token punctuation">:</span>failed</code></pre>
<p><code class=" language-php">queue<span class="token punctuation">:</span>failed</code> 命令将会列出工作的 ID、连接、队列名称及失败的时间，工作的 ID 也可以重新执行一个已经失败的工作，例如一个已经失败的工作他的 ID 是 5，我们可以使用下面的命令：</p>
<pre class=" language-php"><code class=" language-php">php artisan queue<span class="token punctuation">:</span>retry <span class="token number">5</span></code></pre>
<p>假如您会想删除一个已失败的工作，您可以使用 <code class=" language-php">queue<span class="token punctuation">:</span>forget</code> 命令：</p>
<pre class=" language-php"><code class=" language-php">php artisan queue<span class="token punctuation">:</span>forget <span class="token number">5</span></code></pre>
<p>要删除全部失败的工作您可以使用 <code class=" language-php">queue<span class="token punctuation">:</span>flush</code> 命令：</p>
<pre class=" language-php"><code class=" language-php">php artisan queue<span class="token punctuation">:</span>flush</code></pre>
	</article>
</div>

	<footer class="main">
		<ul>
			<li class="nav-docs"><a href="../5.0.html">文档</a></li>
<li class="nav-laracasts"><a href="https://laracasts.com" target="_blank">Laracasts</a></li>
<li class="nav-docs"><a href="http://lumen.laravel-china.org">Lumen</a></li>
<li class="nav-forge"><a href="https://forge.laravel.com" target="_blank">Forge</a></li>
<li class="nav-api" style="display:none"><a href="http://laravel-china.org/api/5.0" target="_blank">API</a></li>
<li class="dropdown">
	<a href="https://phphub.org/" target="_blank">中文开发者社区</a>
</li>
<li class="dropdown">
	<a href="https://phphub.org/topics/453" target="_blank">Slack 聊天室</a>
</li>
<a href="https://github.com/laravel-china/docs" target="_blank"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/a6677b08c955af8400f44c6298f40e7d19cc5b2d/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"></a>
		</ul>
		<p>Laravel is a trademark of Taylor Otwell. Copyright © Taylor Otwell.</p>
		<p class="less-significant"><a href="http://jackmcdade.com">Design by Jack McDade</a></p>
	</footer>
	<script src="../../assets/js/laravel.js"></script>
	<script src="../../assets/js/viewport-units-buggyfill.js"></script>
	<script>window.viewportUnitsBuggyfill.init();</script>
    <script>
        var _gaq=[['_setAccount','UA-53903425-2'],['_trackPageview']];
        (function(d,t){
            var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
            g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
            s.parentNode.insertBefore(g,s)
        }(document,'script'));
    </script>
<script type="text/javascript">window.NREUM||(NREUM={});NREUM.info={"beacon":"bam.nr-data.net","licenseKey":"229d5871c8","applicationID":"12032708","transactionName":"ZFdUZUMCV0UHUURdWl0dY0NYTFBYAldIGkVbQg==","queueTime":0,"applicationTime":35,"ttGuid":"","agentToken":"","atts":"SBBXEwsYREs=","errorBeacon":"bam.nr-data.net","agent":"js-agent.newrelic.com\/nr-632.min.js"}</script><p style="margin: 0px;"></p>

</div></div><a id="scrollUp" href="queues.html#top" style="display: none; position: fixed; z-index: 2147483647;">返回顶部</a></body></html>